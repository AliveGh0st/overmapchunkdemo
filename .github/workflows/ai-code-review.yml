name: AI Code Review

on:
  pull_request:
    types: [opened, synchronize, reopened]
  push:
    branches:
      - main
      - develop
      - 'feature/*'

jobs:
  ai-review:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write
      issues: write
      actions: read

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 2  # è·å–å‰ä¸¤æ¬¡æäº¤ä»¥ä¾¿å¯¹æ¯”

      - name: Get changed files
        id: changed-files
        run: |
          if [ "${{ github.event_name }}" == "pull_request" ]; then
            # Pull Request äº‹ä»¶
            git diff --name-only ${{ github.event.pull_request.base.sha }} ${{ github.event.pull_request.head.sha }} > changed_files.txt
          else
            # Push äº‹ä»¶
            git diff --name-only HEAD~1 HEAD > changed_files.txt
          fi
          echo "changed_files<<EOF" >> $GITHUB_OUTPUT
          cat changed_files.txt >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Get file changes
        id: get-diff
        run: |
          if [ "${{ github.event_name }}" == "pull_request" ]; then
            DIFF=$(git diff ${{ github.event.pull_request.base.sha }} ${{ github.event.pull_request.head.sha }})
          else
            DIFF=$(git diff HEAD~1 HEAD)
          fi
          
          # æˆªæ–­å¤ªé•¿çš„diffä»¥é¿å…è¶…å‡ºAPIé™åˆ¶
          if [ ${#DIFF} -gt 10000 ]; then
            DIFF="${DIFF:0:10000}... [truncated]"
          fi
          
          echo "diff<<EOF" >> $GITHUB_OUTPUT
          echo "$DIFF" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: AI Code Review
        id: ai-review
        uses: actions/github-script@v7
        with:
          script: |
            const diff = `${{ steps.get-diff.outputs.diff }}`;
            const changedFiles = `${{ steps.changed-files.outputs.changed_files }}`;
            
            if (!diff.trim()) {
              console.log('No changes to review');
              return;
            }
            
            const prompt = `
            è¯·ä½œä¸ºä¸€ä¸ªèµ„æ·±çš„è½¯ä»¶å·¥ç¨‹å¸ˆï¼Œå¯¹ä»¥ä¸‹ä»£ç å˜æ›´è¿›è¡Œè¯¦ç»†çš„ä»£ç å®¡æŸ¥ï¼š
            
            å˜æ›´çš„æ–‡ä»¶ï¼š
            ${changedFiles}
            
            ä»£ç å·®å¼‚ï¼š
            \`\`\`diff
            ${diff}
            \`\`\`
            
            è¯·ä»ä»¥ä¸‹å‡ ä¸ªæ–¹é¢è¿›è¡Œå®¡æŸ¥ï¼š
            1. ä»£ç è´¨é‡å’Œæœ€ä½³å®è·µ
            2. æ½œåœ¨çš„bugå’Œå®‰å…¨é—®é¢˜
            3. æ€§èƒ½ä¼˜åŒ–å»ºè®®
            4. ä»£ç å¯è¯»æ€§å’Œç»´æŠ¤æ€§
            5. æ˜¯å¦éµå¾ªé¡¹ç›®çš„ç¼–ç è§„èŒƒ
            6. æµ‹è¯•è¦†ç›–ç‡è€ƒè™‘
            
            è¯·ç”¨ä¸­æ–‡å›å¤ï¼Œå¹¶ä¸”ï¼š
            - å¦‚æœå‘ç°é—®é¢˜ï¼Œè¯·æ˜ç¡®æŒ‡å‡ºé—®é¢˜æ‰€åœ¨çš„è¡Œæ•°å’Œå…·ä½“å»ºè®®
            - å¦‚æœä»£ç å¾ˆå¥½ï¼Œè¯·ç»™å‡ºç§¯æçš„åé¦ˆ
            - æä¾›å…·ä½“çš„æ”¹è¿›å»ºè®®å’Œä»£ç ç¤ºä¾‹ï¼ˆå¦‚æœé€‚ç”¨ï¼‰
            `;
            
            // è¿™é‡Œæˆ‘ä»¬ä½¿ç”¨GitHubçš„AIæ¨¡å‹è¿›è¡Œåˆ†æ
            // æ³¨æ„ï¼šéœ€è¦ç¡®ä¿æœ‰é€‚å½“çš„æƒé™å’ŒAPIè®¿é—®
            try {
              const response = await fetch('https://api.github.com/models/gpt-4o-mini/chat/completions', {
                method: 'POST',
                headers: {
                  'Authorization': `Bearer ${{ secrets.GITHUB_TOKEN }}`,
                  'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                  messages: [
                    {
                      role: 'user',
                      content: prompt
                    }
                  ],
                  max_tokens: 2000,
                  temperature: 0.3
                })
              });
              
              if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
              }
              
              const data = await response.json();
              const reviewComment = data.choices[0].message.content;
              
              core.setOutput('review', reviewComment);
              
            } catch (error) {
              console.error('AI review failed:', error);
              const fallbackComment = `
              ## ğŸ¤– AI ä»£ç å®¡æŸ¥
              
              **å˜æ›´æ–‡ä»¶ï¼š**
              ${changedFiles.split('\n').map(f => f.trim()).filter(f => f).map(f => `- ${f}`).join('\n')}
              
              âš ï¸ AI å®¡æŸ¥æš‚æ—¶ä¸å¯ç”¨ï¼Œè¯·æ‰‹åŠ¨å®¡æŸ¥ä»¥ä¸‹æ–¹é¢ï¼š
              - ä»£ç è´¨é‡å’Œæœ€ä½³å®è·µ
              - æ½œåœ¨çš„ bug å’Œå®‰å…¨é—®é¢˜  
              - æ€§èƒ½ä¼˜åŒ–æœºä¼š
              - ä»£ç å¯è¯»æ€§å’Œç»´æŠ¤æ€§
              - æµ‹è¯•è¦†ç›–ç‡
              
              **æäº¤ä¿¡æ¯ï¼š** ${{ github.event.head_commit.message || github.event.pull_request.title }}
              `;
              
              core.setOutput('review', fallbackComment);
            }

      - name: Comment on Pull Request
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const review = `${{ steps.ai-review.outputs.review }}`;
            
            await github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: `## ğŸ¤– AI ä»£ç å®¡æŸ¥æŠ¥å‘Š\n\n${review}`
            });

      - name: Comment on Commit (for push events)
        if: github.event_name == 'push'
        uses: actions/github-script@v7
        with:
          script: |
            const review = `${{ steps.ai-review.outputs.review }}`;
            
            await github.rest.repos.createCommitComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              commit_sha: context.sha,
              body: `## ğŸ¤– AI ä»£ç å®¡æŸ¥æŠ¥å‘Š\n\n${review}`
            });
