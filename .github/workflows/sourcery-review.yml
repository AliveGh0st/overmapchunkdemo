name: Sourcery AI Review

on:
  pull_request:
    types: [opened, synchronize, reopened]
  push:
    branches: [main, develop]

jobs:
  sourcery-review:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write
      checks: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.x'

      - name: Install Sourcery
        run: |
          pip install sourcery-cli

      - name: Run Sourcery Review
        env:
          SOURCERY_TOKEN: ${{ secrets.SOURCERY_TOKEN }}
        run: |
          # æ£€æŸ¥æ˜¯å¦æœ‰Sourcery token
          if [ -z "$SOURCERY_TOKEN" ]; then
            echo "âš ï¸ SOURCERY_TOKEN not found. Please add it to your repository secrets."
            echo "Visit https://sourcery.ai/ to get your token."
            exit 0
          fi
          
          # è·å–å˜æ›´çš„æ–‡ä»¶
          if [ "${{ github.event_name }}" == "pull_request" ]; then
            # Pull Request
            git diff --name-only ${{ github.event.pull_request.base.sha }} ${{ github.event.pull_request.head.sha }} | grep -E '\.(py|js|ts|gd)$' > changed_files.txt || true
          else
            # Push
            git diff --name-only HEAD~1 HEAD | grep -E '\.(py|js|ts|gd)$' > changed_files.txt || true
          fi
          
          if [ ! -s changed_files.txt ]; then
            echo "No supported files changed"
            exit 0
          fi
          
          # è¿è¡Œ Sourcery åˆ†æ
          echo "Running Sourcery analysis on changed files..."
          cat changed_files.txt
          
          # å¯¹æ¯ä¸ªæ–‡ä»¶è¿è¡ŒSourcery
          while IFS= read -r file; do
            if [ -f "$file" ]; then
              echo "Analyzing $file..."
              sourcery review "$file" --output-format=json > "sourcery_$file.json" 2>/dev/null || echo "Sourcery analysis failed for $file"
            fi
          done < changed_files.txt

      - name: Process Sourcery Results
        id: process-results
        run: |
          # åˆå¹¶æ‰€æœ‰ç»“æœ
          results=""
          file_count=0
          
          for json_file in sourcery_*.json; do
            if [ -f "$json_file" ]; then
              file_count=$((file_count + 1))
              filename=$(echo "$json_file" | sed 's/sourcery_//' | sed 's/.json$//')
              results="$results\n\n### ğŸ“ $filename\n"
              
              # è§£æJSONç»“æœå¹¶æ ¼å¼åŒ–
              if command -v jq > /dev/null; then
                suggestions=$(jq -r '.suggestions[]? | "- **\(.explanation)** (Line \(.line)): \(.description)"' "$json_file" 2>/dev/null || echo "- æ— å»ºè®®")
                if [ -n "$suggestions" ] && [ "$suggestions" != "- æ— å»ºè®®" ]; then
                  results="$results$suggestions"
                else
                  results="$results- âœ… ä»£ç è´¨é‡è‰¯å¥½ï¼Œæ— æ”¹è¿›å»ºè®®"
                fi
              else
                results="$results- â„¹ï¸ æ— æ³•è§£æç»“æœï¼ˆç¼ºå°‘jqå·¥å…·ï¼‰"
              fi
            fi
          done
          
          if [ $file_count -eq 0 ]; then
            results="â„¹ï¸ æ²¡æœ‰æ‰¾åˆ°æ”¯æŒçš„ä»£ç æ–‡ä»¶æˆ–Sourceryåˆ†æå¤±è´¥"
          fi
          
          echo "review_results<<EOF" >> $GITHUB_OUTPUT
          echo -e "$results" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Comment with Sourcery Results
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const results = `${{ steps.process-results.outputs.review_results }}`;
            
            const comment = `## ğŸ” Sourcery AI ä»£ç è´¨é‡åˆ†æ
            
            ${results}
            
            ---
            ğŸ’¡ **æç¤º**: Sourcery ä¸“æ³¨äºä»£ç è´¨é‡æ”¹è¿›å’Œé‡æ„å»ºè®®ã€‚
            ğŸ”— [äº†è§£æ›´å¤šå…³äº Sourcery](https://sourcery.ai/)
            `;
            
            await github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: comment
            });

      - name: Comment on Commit (for push events)
        if: github.event_name == 'push'
        uses: actions/github-script@v7
        with:
          script: |
            const results = `${{ steps.process-results.outputs.review_results }}`;
            
            const comment = `## ğŸ” Sourcery AI ä»£ç è´¨é‡åˆ†æ
            
            ${results}
            
            **æäº¤**: ${{ github.event.head_commit.message }}
            `;
            
            await github.rest.repos.createCommitComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              commit_sha: context.sha,
              body: comment
            });
