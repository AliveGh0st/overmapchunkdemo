name: Sourcery AI Review

on:
  pull_request:
    types: [opened, synchronize, reopened]
  push:
    branches: [main, develop]

jobs:
  sourcery-review:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write
      checks: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.x'

      - name: Install Sourcery
        run: |
          pip install sourcery-cli

      - name: Run Sourcery Review
        env:
          SOURCERY_TOKEN: ${{ secrets.SOURCERY_TOKEN }}
        run: |
          # 检查是否有Sourcery token
          if [ -z "$SOURCERY_TOKEN" ]; then
            echo "⚠️ SOURCERY_TOKEN not found. Please add it to your repository secrets."
            echo "Visit https://sourcery.ai/ to get your token."
            exit 0
          fi
          
          # 获取变更的文件
          if [ "${{ github.event_name }}" == "pull_request" ]; then
            # Pull Request
            git diff --name-only ${{ github.event.pull_request.base.sha }} ${{ github.event.pull_request.head.sha }} | grep -E '\.(py|js|ts|gd)$' > changed_files.txt || true
          else
            # Push
            git diff --name-only HEAD~1 HEAD | grep -E '\.(py|js|ts|gd)$' > changed_files.txt || true
          fi
          
          if [ ! -s changed_files.txt ]; then
            echo "No supported files changed"
            exit 0
          fi
          
          # 运行 Sourcery 分析
          echo "Running Sourcery analysis on changed files..."
          cat changed_files.txt
          
          # 对每个文件运行Sourcery
          while IFS= read -r file; do
            if [ -f "$file" ]; then
              echo "Analyzing $file..."
              sourcery review "$file" --output-format=json > "sourcery_$file.json" 2>/dev/null || echo "Sourcery analysis failed for $file"
            fi
          done < changed_files.txt

      - name: Process Sourcery Results
        id: process-results
        run: |
          # 合并所有结果
          results=""
          file_count=0
          
          for json_file in sourcery_*.json; do
            if [ -f "$json_file" ]; then
              file_count=$((file_count + 1))
              filename=$(echo "$json_file" | sed 's/sourcery_//' | sed 's/.json$//')
              results="$results\n\n### 📁 $filename\n"
              
              # 解析JSON结果并格式化
              if command -v jq > /dev/null; then
                suggestions=$(jq -r '.suggestions[]? | "- **\(.explanation)** (Line \(.line)): \(.description)"' "$json_file" 2>/dev/null || echo "- 无建议")
                if [ -n "$suggestions" ] && [ "$suggestions" != "- 无建议" ]; then
                  results="$results$suggestions"
                else
                  results="$results- ✅ 代码质量良好，无改进建议"
                fi
              else
                results="$results- ℹ️ 无法解析结果（缺少jq工具）"
              fi
            fi
          done
          
          if [ $file_count -eq 0 ]; then
            results="ℹ️ 没有找到支持的代码文件或Sourcery分析失败"
          fi
          
          echo "review_results<<EOF" >> $GITHUB_OUTPUT
          echo -e "$results" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Comment with Sourcery Results
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const results = `${{ steps.process-results.outputs.review_results }}`;
            
            const comment = `## 🔍 Sourcery AI 代码质量分析
            
            ${results}
            
            ---
            💡 **提示**: Sourcery 专注于代码质量改进和重构建议。
            🔗 [了解更多关于 Sourcery](https://sourcery.ai/)
            `;
            
            await github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: comment
            });

      - name: Comment on Commit (for push events)
        if: github.event_name == 'push'
        uses: actions/github-script@v7
        with:
          script: |
            const results = `${{ steps.process-results.outputs.review_results }}`;
            
            const comment = `## 🔍 Sourcery AI 代码质量分析
            
            ${results}
            
            **提交**: ${{ github.event.head_commit.message }}
            `;
            
            await github.rest.repos.createCommitComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              commit_sha: context.sha,
              body: comment
            });
