name: Code Quality Check

on:
  pull_request:
    types: [opened, synchronize, reopened]
  push:
    branches: [main, develop]

jobs:
  comprehensive-review:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write
      checks: write
      issues: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 2

      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.x'

      - name: Install analysis tools
        run: |
          pip install flake8 pylint bandit safety
          npm install -g eslint jshint

      - name: Analyze changed files
        id: analyze
        run: |
          # è·å–å˜æ›´æ–‡ä»¶
          if [ "${{ github.event_name }}" == "pull_request" ]; then
            git diff --name-only ${{ github.event.pull_request.base.sha }} ${{ github.event.pull_request.head.sha }} > changed_files.txt
          else
            git diff --name-only HEAD~1 HEAD > changed_files.txt
          fi
          
          analysis_report=""
          
          # åˆ†æä¸åŒç±»å‹çš„æ–‡ä»¶
          echo "## ğŸ“Š ä»£ç è´¨é‡åˆ†ææŠ¥å‘Š" > analysis_report.md
          echo "" >> analysis_report.md
          
          # GDScript æ–‡ä»¶åˆ†æ
          gdscript_files=$(grep '\.gd$' changed_files.txt || true)
          if [ -n "$gdscript_files" ]; then
            echo "### ğŸ® GDScript æ–‡ä»¶" >> analysis_report.md
            echo "$gdscript_files" | while read -r file; do
              if [ -f "$file" ]; then
                echo "#### ğŸ“„ $file" >> analysis_report.md
                
                # ç®€å•çš„ä»£ç è´¨é‡æ£€æŸ¥
                lines=$(wc -l < "$file")
                echo "- **è¡Œæ•°**: $lines" >> analysis_report.md
                
                # æ£€æŸ¥å¸¸è§é—®é¢˜
                if grep -q "print(" "$file"; then
                  echo "- âš ï¸ åŒ…å«è°ƒè¯•è¾“å‡ºè¯­å¥" >> analysis_report.md
                fi
                
                if grep -q "TODO\|FIXME\|HACK" "$file"; then
                  echo "- ğŸ“ åŒ…å«å¾…åŠäº‹é¡¹æˆ–ä¸´æ—¶ä¿®å¤" >> analysis_report.md
                fi
                
                # æ£€æŸ¥å‡½æ•°å¤æ‚åº¦ï¼ˆç®€å•ç‰ˆæœ¬ï¼‰
                func_count=$(grep -c "^func " "$file" || echo "0")
                echo "- **å‡½æ•°æ•°é‡**: $func_count" >> analysis_report.md
                
                if [ $lines -gt 500 ]; then
                  echo "- âš ï¸ æ–‡ä»¶è¾ƒé•¿ï¼Œè€ƒè™‘æ‹†åˆ†" >> analysis_report.md
                fi
                
                echo "" >> analysis_report.md
              fi
            done
          fi
          
          # Python æ–‡ä»¶åˆ†æï¼ˆå¦‚æœæœ‰ï¼‰
          python_files=$(grep '\.py$' changed_files.txt || true)
          if [ -n "$python_files" ]; then
            echo "### ğŸ Python æ–‡ä»¶" >> analysis_report.md
            echo "$python_files" | while read -r file; do
              if [ -f "$file" ]; then
                echo "#### ğŸ“„ $file" >> analysis_report.md
                
                # Flake8 æ£€æŸ¥
                flake8_output=$(flake8 "$file" --max-line-length=100 2>/dev/null || echo "æ— é—®é¢˜")
                if [ "$flake8_output" != "æ— é—®é¢˜" ]; then
                  echo "**é£æ ¼é—®é¢˜**:" >> analysis_report.md
                  echo '```' >> analysis_report.md
                  echo "$flake8_output" >> analysis_report.md
                  echo '```' >> analysis_report.md
                else
                  echo "- âœ… ä»£ç é£æ ¼è‰¯å¥½" >> analysis_report.md
                fi
                
                # å®‰å…¨æ£€æŸ¥
                bandit_output=$(bandit -f txt "$file" 2>/dev/null || echo "æ— å®‰å…¨é—®é¢˜")
                if [[ "$bandit_output" == *"No issues identified"* ]] || [ "$bandit_output" = "æ— å®‰å…¨é—®é¢˜" ]; then
                  echo "- âœ… æ— å®‰å…¨é—®é¢˜" >> analysis_report.md
                else
                  echo "**å®‰å…¨é—®é¢˜**:" >> analysis_report.md
                  echo '```' >> analysis_report.md
                  echo "$bandit_output" >> analysis_report.md
                  echo '```' >> analysis_report.md
                fi
                
                echo "" >> analysis_report.md
              fi
            done
          fi
          
          # JavaScript/TypeScript æ–‡ä»¶åˆ†æ
          js_files=$(grep -E '\.(js|ts)$' changed_files.txt || true)
          if [ -n "$js_files" ]; then
            echo "### ğŸ“œ JavaScript/TypeScript æ–‡ä»¶" >> analysis_report.md
            echo "$js_files" | while read -r file; do
              if [ -f "$file" ]; then
                echo "#### ğŸ“„ $file" >> analysis_report.md
                
                # JSHint æ£€æŸ¥
                jshint_output=$(jshint "$file" 2>/dev/null || echo "JSHint æ£€æŸ¥å®Œæˆ")
                if [[ "$jshint_output" != *"error"* ]] && [ "$jshint_output" = "JSHint æ£€æŸ¥å®Œæˆ" ]; then
                  echo "- âœ… ä»£ç è´¨é‡è‰¯å¥½" >> analysis_report.md
                else
                  echo "**ä»£ç é—®é¢˜**:" >> analysis_report.md
                  echo '```' >> analysis_report.md
                  echo "$jshint_output" >> analysis_report.md
                  echo '```' >> analysis_report.md
                fi
                
                echo "" >> analysis_report.md
              fi
            done
          fi
          
          # æ·»åŠ é€šç”¨å»ºè®®
          echo "### ğŸ’¡ é€šç”¨å»ºè®®" >> analysis_report.md
          echo "- ç¡®ä¿æ‰€æœ‰æ–°åŠŸèƒ½éƒ½æœ‰é€‚å½“çš„æ³¨é‡Š" >> analysis_report.md
          echo "- è€ƒè™‘æ·»åŠ å•å…ƒæµ‹è¯•è¦†ç›–æ–°ä»£ç " >> analysis_report.md
          echo "- æ£€æŸ¥æ˜¯å¦éœ€è¦æ›´æ–°æ–‡æ¡£" >> analysis_report.md
          echo "- ç¡®ä¿éµå¾ªé¡¹ç›®çš„ç¼–ç è§„èŒƒ" >> analysis_report.md
          echo "" >> analysis_report.md
          
          echo "### ğŸ“ˆ æäº¤ç»Ÿè®¡" >> analysis_report.md
          total_files=$(wc -l < changed_files.txt)
          echo "- **å˜æ›´æ–‡ä»¶æ•°**: $total_files" >> analysis_report.md
          
          if [ "${{ github.event_name }}" == "pull_request" ]; then
            additions=$(git diff --numstat ${{ github.event.pull_request.base.sha }} ${{ github.event.pull_request.head.sha }} | awk '{sum+=$1} END {print sum}')
            deletions=$(git diff --numstat ${{ github.event.pull_request.base.sha }} ${{ github.event.pull_request.head.sha }} | awk '{sum+=$2} END {print sum}')
          else
            additions=$(git diff --numstat HEAD~1 HEAD | awk '{sum+=$1} END {print sum}')
            deletions=$(git diff --numstat HEAD~1 HEAD | awk '{sum+=$2} END {print sum}')
          fi
          
          echo "- **æ–°å¢è¡Œæ•°**: ${additions:-0}" >> analysis_report.md
          echo "- **åˆ é™¤è¡Œæ•°**: ${deletions:-0}" >> analysis_report.md
          
          # è®¾ç½®è¾“å‡º
          echo "analysis_report<<EOF" >> $GITHUB_OUTPUT
          cat analysis_report.md >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Comment on Pull Request
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const report = `${{ steps.analyze.outputs.analysis_report }}`;
            
            await github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: report
            });

      - name: Comment on Commit
        if: github.event_name == 'push'
        uses: actions/github-script@v7
        with:
          script: |
            const report = `${{ steps.analyze.outputs.analysis_report }}`;
            
            await github.rest.repos.createCommitComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              commit_sha: context.sha,
              body: report
            });
